<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>elkhatta | Ø§Ù„Ù…Ù†ØµØ© Ø§Ù„ØªØ¹Ù„ÙŠÙ…ÙŠØ©</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, doc, updateDoc, deleteDoc, serverTimestamp, query, orderBy, limit } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-firestore.js";

        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyD6Km2JHC8B_-appNfQfntSQjZFjNha4TE",
            authDomain: "team-30904.firebaseapp.com",
            databaseURL: "https://team-30904-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "team-30904",
            storageBucket: "team-30904.firebasestorage.app",
            messagingSenderId: "410017809901",
            appId: "1:410017809901:web:79d5c13ba8d7a3ad0153e4",
            measurementId: "G-M91H1BFLR5"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'elkhatta-v6-final';

        // Global API Bridge
        window.fb = { 
            auth, db, appId, collection, addDoc, onSnapshot, doc, updateDoc, deleteDoc, serverTimestamp, query, orderBy, limit,
            getCol: (name) => collection(db, 'artifacts', appId, 'public', 'data', name),
            getDocRef: (name, id) => doc(db, 'artifacts', appId, 'public', 'data', name, id)
        };

        // Authentication & Connection Check (Fixed Rule 3 logic)
        const initAuth = async () => {
            console.log("Attempting to connect to Firebase...");
            try {
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    try {
                        await signInWithCustomToken(auth, __initial_auth_token);
                    } catch (tokenErr) {
                        console.warn("Custom token failed, falling back to anonymous login...");
                        await signInAnonymously(auth);
                    }
                } else {
                    await signInAnonymously(auth);
                }
            } catch (err) { 
                console.error("Firebase Connection Error:", err.message);
                window.updateConnectionStatus(false);
            }
        };

        onAuthStateChanged(auth, (user) => {
            window.user = user;
            if (user) {
                console.log("%câœ” Firebase Connected Successfully", "color: green; font-weight: bold; font-size: 12px;");
                window.updateConnectionStatus(true);
                if (window.startApp) window.startApp();
            } else {
                window.updateConnectionStatus(false);
            }
        });

        initAuth();
    </script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;900&display=swap');
        body { font-family: 'Tajawal', sans-serif; background-color: #F8FAFC; }
        .section-view { display: none; }
        .section-view.active { display: block; animation: fadeIn 0.4s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-thumb { background: #3b82f6; border-radius: 10px; }
        .status-dot { width: 8px; height: 8px; border-radius: 50%; display: inline-block; margin-right: 8px; }
        .status-online { background-color: #22c55e; box-shadow: 0 0 8px #22c55e; }
        .status-offline { background-color: #94a3b8; }
    </style>
</head>
<body class="text-slate-800 overflow-x-hidden">

    <!-- Toast Notification -->
    <div id="toast" class="fixed bottom-10 right-1/2 translate-x-1/2 z-[1000] bg-slate-900 text-white px-8 py-3 rounded-full shadow-2xl flex items-center gap-3 opacity-0 pointer-events-none transition-all duration-300 border border-slate-700">
        <i data-lucide="check-circle" class="text-green-400 w-5 h-5"></i>
        <span id="toast-text" class="text-sm font-bold"></span>
    </div>

    <!-- Navigation -->
    <nav class="bg-white/90 backdrop-blur-md border-b border-slate-100 sticky top-0 z-[100] h-16 flex items-center justify-between px-6 shadow-sm">
        <div class="flex items-center gap-6">
            <div onclick="navigateTo('dashboard')" class="flex items-center gap-2 cursor-pointer group">
                <div class="bg-blue-600 p-1.5 rounded-lg shadow-lg group-hover:rotate-6 transition-transform">
                    <i data-lucide="graduation-cap" class="text-white w-5 h-5"></i>
                </div>
                <div class="flex flex-col">
                    <span class="text-2xl font-black text-slate-900 tracking-tighter italic leading-none">elkhatta</span>
                    <div class="flex items-center mt-1">
                        <span id="connection-dot" class="status-dot status-offline"></span>
                        <span id="connection-text" class="text-[9px] font-bold text-slate-400 uppercase">Offline</span>
                    </div>
                </div>
            </div>
            <div class="hidden md:flex gap-6">
                <button onclick="navigateTo('dashboard')" class="nav-btn text-sm font-black text-blue-600" id="btn-nav-dashboard">Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</button>
                <button onclick="navigateTo('support')" class="nav-btn text-sm font-black text-slate-400 hover:text-blue-600 transition-colors" id="btn-nav-support">Ø£Ø³Ø¦Ù„ØªÙŠ</button>
            </div>
        </div>
        <div onclick="openAdminLogin()" class="p-2.5 rounded-xl bg-slate-50 text-slate-400 hover:bg-blue-600 hover:text-white transition-all cursor-pointer shadow-sm">
            <i data-lucide="lock" class="w-5 h-5"></i>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="max-w-5xl mx-auto px-4 py-8 min-h-[80vh]">
        
        <!-- Dashboard Section -->
        <section id="view-dashboard" class="section-view active space-y-12">
            <!-- Hero -->
            <header class="bg-gradient-to-br from-blue-700 via-indigo-700 to-indigo-900 rounded-[3.5rem] p-10 text-white shadow-2xl relative overflow-hidden text-right">
                <div class="relative z-10">
                    <h1 class="text-4xl md:text-6xl font-black mb-6 leading-tight text-right">Ø¨ÙˆØ§Ø¨ØªÙƒ Ù„Ù„ØªÙ…ÙŠØ² <br/> ÙÙŠ Ø§Ù„Ø®Ø¯Ù…Ø© Ø§Ù„Ø§Ø¬ØªÙ…Ø§Ø¹ÙŠØ© ğŸš€</h1>
                    <p class="opacity-80 text-lg mb-10 max-w-md leading-relaxed text-right">Ù…Ù†ØµØ© elkhatta Ø§Ù„ØªØ¹Ù„ÙŠÙ…ÙŠØ© ØªÙˆÙØ± Ù„Ùƒ Ø£Ø­Ø¯Ø« Ø§Ù„Ù…Ø­Ø§Ø¶Ø±Ø§Øª ÙˆØ§Ù„Ø§Ù…ØªØ­Ø§Ù†Ø§Øª Ø§Ù„ØªÙØ§Ø¹Ù„ÙŠØ© Ø§Ù„Ù…Ø±ØªØ¨Ø·Ø© Ø¨Ù‚Ø§Ø¹Ø¯Ø© Ø¨ÙŠØ§Ù†Ø§Øª Ø³Ø­Ø§Ø¨ÙŠØ©.</p>
                    <button onclick="document.getElementById('subjects-sec').scrollIntoView({behavior:'smooth'})" class="bg-white text-blue-800 px-10 py-4 rounded-[1.5rem] font-black shadow-xl hover:scale-105 transition-all">Ø§Ø³ØªØ¹Ø±Ø¶ Ø§Ù„ÙƒÙˆØ±Ø³Ø§Øª</button>
                </div>
                <div class="absolute -left-10 -bottom-10 w-80 h-80 bg-white/10 rounded-full blur-[100px]"></div>
            </header>

            <div id="latest-sec">
                <div class="flex items-center gap-3 mb-8 px-2">
                    <div class="h-8 w-1.5 bg-orange-500 rounded-full shadow-lg"></div>
                    <h2 class="text-2xl font-black text-gray-800">Ø£Ø­Ø¯Ø« Ø§Ù„Ù…Ø­Ø§Ø¶Ø±Ø§Øª ÙˆØ§Ù„Ø§Ù…ØªØ­Ø§Ù†Ø§Øª</h2>
                </div>
                <div id="latest-list" class="grid sm:grid-cols-2 lg:grid-cols-3 gap-6 animate-fade"></div>
            </div>

            <div id="subjects-sec">
                <div class="flex items-center gap-3 mb-8 px-2">
                    <div class="h-8 w-1.5 bg-blue-600 rounded-full shadow-lg"></div>
                    <h2 class="text-2xl font-black text-gray-800">Ø§Ù„Ù…ÙˆØ§Ø¯ Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠØ© (Ø§Ù„ÙƒÙˆØ±Ø³Ø§Øª)</h2>
                </div>
                <div id="subjects-list" class="grid sm:grid-cols-2 gap-8 text-right"></div>
            </div>
        </section>

        <!-- Subject Detail View -->
        <section id="view-subject" class="section-view space-y-8">
            <div class="flex items-center justify-between">
                <button onclick="navigateTo('dashboard')" class="flex items-center gap-2 text-blue-600 font-bold hover:gap-4 transition-all">
                    <i data-lucide="arrow-right" class="rotate-180 w-5 h-5"></i> Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
                </button>
                <h1 id="subj-title-display" class="text-3xl font-black text-gray-800 text-right"></h1>
            </div>
            <div id="lec-list-display" class="grid gap-4"></div>
        </section>

        <!-- Lecture Player -->
        <section id="view-lecture" class="section-view space-y-8 text-right">
            <div class="flex items-center justify-between">
                <button id="back-btn-action" class="flex items-center gap-2 text-blue-600 font-bold hover:gap-4 transition-all">
                    <i data-lucide="arrow-right" class="rotate-180 w-5 h-5"></i> Ø±Ø¬ÙˆØ¹
                </button>
                <h1 id="lec-title-display" class="text-2xl font-black text-gray-800"></h1>
            </div>
            <div class="bg-white rounded-[3rem] shadow-2xl overflow-hidden border border-slate-100 text-center">
                <div id="video-box" class="w-full aspect-video bg-slate-900 flex items-center justify-center"></div>
                <div class="p-10 flex flex-wrap gap-4 justify-center">
                    <button id="lec-pdf-btn" class="flex-1 min-w-[240px] bg-red-50 text-red-600 py-5 rounded-3xl font-black flex items-center justify-center gap-3 border border-red-100 hover:bg-red-100 transition-all shadow-sm">
                        <i data-lucide="file-text" class="w-6 h-6"></i> ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù„Ø²Ù…Ø© (PDF)
                    </button>
                    <button id="lec-exam-btn" class="flex-1 min-w-[240px] bg-purple-600 text-white py-5 rounded-3xl font-black flex items-center justify-center gap-3 shadow-xl shadow-purple-100 hover:bg-purple-700 transition-all">
                        <i data-lucide="clipboard-check" class="w-6 h-6"></i> Ø¨Ø¯Ø¡ Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ù…Ø­Ø§Ø¶Ø±Ø©
                    </button>
                </div>
            </div>
            <button onclick="navigateTo('dashboard')" class="w-full py-5 text-slate-400 font-bold hover:text-slate-600 underline text-center">Ø±Ø¬ÙˆØ¹ Ù„Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</button>
        </section>

        <!-- Exam View -->
        <section id="view-exam" class="section-view max-w-2xl mx-auto py-10 animate-fade">
            <div id="exam-container" class="bg-white p-10 rounded-[3.5rem] shadow-2xl border border-blue-50 text-right"></div>
        </section>

        <!-- Support Section -->
        <section id="view-support" class="section-view space-y-12 text-right">
            <div class="bg-white p-12 rounded-[3.5rem] shadow-lg text-center border border-indigo-50">
                <i data-lucide="message-circle" class="w-12 h-12 text-indigo-600 mx-auto mb-4"></i>
                <h2 class="text-2xl font-black text-gray-800 mb-2">ÙƒÙŠÙ ÙŠÙ…ÙƒÙ†Ù†Ø§ Ù…Ø³Ø§Ø¹Ø¯ØªÙƒØŸ</h2>
                <textarea id="support-input" class="w-full p-6 bg-slate-50 rounded-[2rem] border-none mb-6 min-h-[150px] text-lg focus:ring-4 focus:ring-indigo-100 shadow-inner" placeholder="Ø§ÙƒØªØ¨ Ø³Ø¤Ø§Ù„Ùƒ Ù‡Ù†Ø§..."></textarea>
                <button onclick="sendMsg()" class="w-full bg-indigo-600 text-white py-4 rounded-2xl font-black shadow-xl shadow-indigo-100 hover:bg-indigo-700 transition-all">Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø³Ø¤Ø§Ù„</button>
            </div>
            <div id="messages-display" class="space-y-6"></div>
        </section>

        <!-- Admin Control Panel -->
        <section id="view-admin" class="section-view space-y-8 text-right">
            <div class="flex bg-white p-2 rounded-2xl shadow-sm gap-2 overflow-x-auto border border-slate-100">
                <button onclick="renderAdmin('subjects')" class="adm-tab flex-1 px-6 py-3 rounded-xl font-black transition-all bg-blue-600 text-white shadow-lg">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ÙƒÙˆØ±Ø³Ø§Øª</button>
                <button onclick="renderAdmin('lectures')" class="adm-tab flex-1 px-6 py-3 rounded-xl font-black transition-all text-slate-400 hover:bg-slate-50">Ø±ÙØ¹ Ù…Ø­Ø§Ø¶Ø±Ø§Øª</button>
                <button onclick="renderAdmin('exams')" class="adm-tab flex-1 px-6 py-3 rounded-xl font-black transition-all text-slate-400 hover:bg-slate-50">Ø¨Ù†Ùƒ Ø§Ù„Ø§Ù…ØªØ­Ø§Ù†Ø§Øª</button>
                <button onclick="renderAdmin('msgs')" class="adm-tab flex-1 px-6 py-3 rounded-xl font-black transition-all text-slate-400 hover:bg-slate-50">Ø§Ù„Ø±Ø¯ÙˆØ¯</button>
            </div>
            <div id="admin-render-area" class="space-y-6"></div>
        </section>

    </main>

    <!-- Admin Login Modal -->
    <div id="login-modal" class="fixed inset-0 z-[500] bg-slate-900/60 backdrop-blur-md hidden items-center justify-center p-4">
        <div class="bg-white p-12 rounded-[3.5rem] w-full max-w-sm shadow-2xl text-center animate-fade">
            <h2 class="text-3xl font-black mb-8 text-gray-800 tracking-tighter">Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©</h2>
            <input type="password" id="pass-field" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±" class="w-full p-5 bg-slate-50 rounded-2xl text-center font-black tracking-widest text-2xl border-none focus:ring-4 focus:ring-blue-100 mb-6 shadow-inner">
            <button onclick="checkPass()" class="w-full bg-blue-600 text-white py-4 rounded-2xl font-black shadow-xl hover:bg-blue-700 transition-all">Ø¯Ø®ÙˆÙ„</button>
            <button onclick="closeAdminLogin()" class="mt-4 text-slate-400 font-bold">Ø¥Ù„ØºØ§Ø¡</button>
        </div>
    </div>

    <!-- Mobile Navigation -->
    <div class="md:hidden fixed bottom-6 left-6 right-6 bg-white/90 backdrop-blur-xl border border-slate-100 p-4 flex justify-around items-center rounded-[2rem] shadow-2xl z-[40]">
        <button onclick="navigateTo('dashboard')" class="p-3 rounded-2xl transition-all" id="mob-dashboard"><i data-lucide="layout"></i></button>
        <button onclick="navigateTo('support')" class="p-3 rounded-2xl transition-all text-slate-400" id="mob-support"><i data-lucide="message-circle"></i></button>
    </div>

    <footer class="py-16 text-center text-slate-400 border-t border-slate-50 bg-white mt-20">
        <p class="font-bold text-sm italic tracking-widest">elkhatta Educational Platform Â© 2024</p>
    </footer>

    <script>
        let appData = { subjects: [], lectures: [], exams: [], messages: [], currentAdminTab: 'subjects' };
        let activeExamData = null, examIdx = 0, examScore = 0;
        
        const SOCIAL_WORK_SUBJECTS = ["Ù†Ù…Ø§Ø°Ø¬ Ø§Ù„Ø¹Ù…Ù„ Ù…Ø¹ Ø£ÙØ±Ø§Ø¯", "Ù†Ù…Ø§Ø°Ø¬ Ø§Ù„Ø¹Ù…Ù„ Ù…Ø¹ Ø¬Ù…Ø§Ø¹Ø§Øª", "Ù†Ù…Ø§Ø°Ø¬ Ø§Ù„Ø¹Ù…Ù„ Ù…Ø¹ Ù…Ø¬ØªÙ…Ø¹Ø§Øª", "Ø¯ÙØ§Ø¹ Ø§Ù„Ø§Ø¬ØªÙ…Ø§Ø¹ÙŠ", "Ø§Ù„Ø¨Ø­Ø« Ø§Ù„Ø§Ø¬ØªÙ…Ø§Ø¹ÙŠ", "ØªÙ†Ù…ÙŠØ© Ø§Ù„Ù…Ø¬ØªÙ…Ø¹Ø§Øª", "ØªÙ‚ÙˆÙŠÙ… Ø§Ù„Ø¨Ø±Ø§Ù…Ø¬ Ùˆ Ù…Ø´Ø±ÙˆØ¹Ø§Øª", "ØªØ¯Ø±ÙŠØ¨ Ø§Ù„Ù…ÙŠØ¯Ø§Ù†ÙŠ"];

        window.updateConnectionStatus = (online) => {
            const dot = document.getElementById('connection-dot');
            const text = document.getElementById('connection-text');
            if(online) {
                dot.className = "status-dot status-online";
                text.innerText = "Online";
                text.classList.replace('text-slate-400', 'text-green-500');
            } else {
                dot.className = "status-dot status-offline";
                text.innerText = "Disconnected";
                text.classList.replace('text-green-500', 'text-slate-400');
            }
        };

        function navigateTo(id) {
            document.querySelectorAll('.section-view').forEach(v => v.classList.remove('active'));
            document.getElementById(`view-${id}`).classList.add('active');
            
            document.querySelectorAll('.nav-btn').forEach(btn => btn.classList.replace('text-blue-600', 'text-slate-400'));
            const activeBtn = document.getElementById(`btn-nav-${id}`);
            if(activeBtn) activeBtn.classList.replace('text-slate-400', 'text-blue-600');

            if(id === 'dashboard') renderDashboard();
            if(id === 'support') renderSupport();
            
            lucide.createIcons();
            window.scrollTo(0,0);
        }

        function showToast(msg) {
            const t = document.getElementById('toast');
            document.getElementById('toast-text').innerText = msg;
            t.classList.add('opacity-100', 'translate-y-[-10px]');
            setTimeout(() => t.classList.remove('opacity-100', 'translate-y-[-10px]'), 3000);
        }

        function openAdminLogin() { document.getElementById('login-modal').style.display = 'flex'; }
        function closeAdminLogin() { document.getElementById('login-modal').style.display = 'none'; }
        function checkPass() {
            if(document.getElementById('pass-field').value === '2005') {
                closeAdminLogin();
                navigateTo('admin');
                renderAdmin('subjects');
            } else { showToast("ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø± Ø®Ø·Ø£"); }
        }

        window.startApp = () => {
            const sync = (colName, key) => {
                window.fb.onSnapshot(window.fb.getCol(colName), (s) => {
                    appData[key] = s.docs.map(d => ({id: d.id, ...d.data()}));
                    refreshCurrent();
                });
            };
            sync('subjects', 'subjects');
            sync('lectures', 'lectures');
            sync('exams', 'exams');
            sync('messages', 'messages');
        };

        function refreshCurrent() {
            const active = document.querySelector('.section-view.active').id;
            if(active === 'view-dashboard') renderDashboard();
            if(active === 'view-support') renderSupport();
            if(active === 'view-admin') renderAdmin(appData.currentAdminTab);
        }

        function renderDashboard() {
            const combined = [
                ...appData.lectures.map(l => ({...l, type: 'lecture'})),
                ...appData.exams.filter(e => !appData.lectures.some(l => l.examId === e.id)).map(e => ({...e, type: 'exam'}))
            ].sort((a,b) => (b.createdAt?.seconds || 0) - (a.createdAt?.seconds || 0)).slice(0, 6);

            document.getElementById('latest-list').innerHTML = combined.map(item => `
                <div onclick="${item.type === 'lecture' ? `openLecture('${item.id}')` : `startStandaloneExam('${item.id}')`}" class="bg-white p-6 rounded-[2.5rem] shadow-sm border border-slate-50 flex items-center gap-4 cursor-pointer hover:shadow-xl transition-all group">
                    <div class="h-14 w-14 ${item.type === 'lecture' ? 'bg-orange-50 text-orange-600' : 'bg-purple-50 text-purple-600'} rounded-2xl flex items-center justify-center shrink-0 group-hover:scale-110 transition-transform shadow-sm shadow-orange-100">
                        <i data-lucide="${item.type === 'lecture' ? 'play-circle' : 'clipboard-list'}" class="w-8 h-8"></i>
                    </div>
                    <div class="overflow-hidden text-right flex-1">
                        <h4 class="font-black text-slate-800 truncate text-lg tracking-tight">${item.title}</h4>
                        <p class="text-[10px] font-bold text-slate-400 uppercase tracking-tighter">${item.type === 'lecture' ? 'Ù…Ø­Ø§Ø¶Ø±Ø© Ø¬Ø¯ÙŠØ¯Ø©' : 'Ø§Ù…ØªØ­Ø§Ù† Ù…Ø³ØªÙ‚Ù„'}</p>
                    </div>
                </div>
            `).join('') || '<p class="col-span-full py-10 text-center text-slate-300 font-bold italic text-right">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø¥Ø¶Ø§ÙØ§Øª Ø­Ø¯ÙŠØ«Ø©</p>';

            document.getElementById('subjects-list').innerHTML = appData.subjects.map(s => `
                <div onclick="openSubject('${s.id}')" class="bg-white p-10 rounded-[3.5rem] shadow-sm border border-slate-100 hover:shadow-2xl hover:border-blue-200 transition-all cursor-pointer group">
                    <div class="h-16 w-16 bg-blue-50 text-blue-600 rounded-[1.5rem] flex items-center justify-center mb-8 group-hover:bg-blue-600 group-hover:text-white transition-all shadow-sm">
                        <i data-lucide="book-open" class="w-8 h-8"></i>
                    </div>
                    <h3 class="text-3xl font-black text-slate-800 tracking-tight text-right">${s.name}</h3>
                    <p class="text-slate-400 font-bold mt-4 leading-relaxed italic text-sm text-right">Ø§Ø³ØªØ¹Ø±Ø¶ Ù…Ø­Ø§Ø¶Ø±Ø§Øª ÙˆÙ…Ù„Ø®ØµØ§Øª Ù…Ø§Ø¯Ø© ${s.name}</p>
                </div>
            `).join('') || '<p class="col-span-full py-20 text-center text-slate-300 font-bold italic border-2 border-dashed rounded-[3rem] text-right">Ù„Ù… ÙŠØªÙ… Ø¥Ø¶Ø§ÙØ© Ù…ÙˆØ§Ø¯ Ø¨Ø¹Ø¯</p>';
            lucide.createIcons();
        }

        function openSubject(sid) {
            const s = appData.subjects.find(x => x.id === sid);
            if(!s) return;
            document.getElementById('subj-title-display').innerText = s.name;
            const filtered = appData.lectures.filter(l => l.subjectId === sid);
            document.getElementById('lec-list-display').innerHTML = filtered.map(l => `
                <div class="bg-white p-8 rounded-[2.5rem] border border-slate-100 shadow-sm flex flex-col md:flex-row justify-between items-center gap-6 hover:shadow-md transition-all text-right">
                    <div class="flex items-center gap-5 w-full text-right">
                        <div class="h-16 w-16 bg-indigo-50 text-indigo-600 rounded-[1.5rem] flex items-center justify-center shrink-0 shadow-inner">
                            <i data-lucide="play" class="fill-current w-6 h-6"></i>
                        </div>
                        <div class="text-right">
                            <h3 class="text-2xl font-black text-slate-800">${l.title}</h3>
                            <p class="text-sm text-slate-400 font-bold mt-1">ØªØªØ¶Ù…Ù† Ø§Ù„Ù…Ø­Ø§Ø¶Ø±Ø©: ÙÙŠØ¯ÙŠÙˆ + Ù…Ù„Ø²Ù…Ø© + Ø§Ø®ØªØ¨Ø§Ø±</p>
                        </div>
                    </div>
                    <button onclick="openLecture('${l.id}')" class="bg-blue-600 text-white px-10 py-3 rounded-2xl font-black shadow-xl active:scale-95 transition-all whitespace-nowrap">Ø¨Ø¯Ø£ Ø§Ù„Ø¯Ø±Ø³</button>
                </div>
            `).join('') || '<p class="py-20 text-center text-slate-400 font-bold italic text-right">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø­Ø§Ø¶Ø±Ø§Øª Ù…Ø¶Ø§ÙØ©</p>';
            navigateTo('subject');
        }

        function openLecture(lid) {
            const l = appData.lectures.find(x => x.id === lid);
            if(!l) return;
            document.getElementById('lec-title-display').innerText = l.title;
            const vBox = document.getElementById('video-box');
            vBox.innerHTML = l.videoUrl ? `<video src="${l.videoUrl}" controls class="w-full aspect-video shadow-2xl"></video>` : `<div class="flex flex-col items-center gap-4 text-slate-500"><i data-lucide="video-off" class="w-16 h-16 opacity-30"></i><p class="font-black text-right">Ù„Ø§ ÙŠÙˆØ¬Ø¯ ÙÙŠØ¯ÙŠÙˆ Ù„Ù„Ù…Ø´Ø§Ù‡Ø¯Ø©</p></div>`;
            
            document.getElementById('lec-pdf-btn').style.display = l.pdfUrl ? 'flex' : 'none';
            document.getElementById('lec-pdf-btn').onclick = () => window.open(l.pdfUrl);

            const exam = appData.exams.find(e => e.id === l.examId);
            document.getElementById('lec-exam-btn').style.display = exam ? 'flex' : 'none';
            document.getElementById('lec-exam-btn').onclick = () => startExam(exam);

            document.getElementById('back-btn-action').onclick = () => openSubject(l.subjectId);
            navigateTo('lecture');
        }

        function startStandaloneExam(eid) { const exam = appData.exams.find(e => e.id === eid); if(exam) startExam(exam); }

        function startExam(exam) {
            try {
                const raw = JSON.parse(exam.content);
                activeExamData = Array.isArray(raw) ? raw : (raw.questions || []);
                activeExamData = activeExamData.map(q => ({
                    question: q.q || q.question,
                    options: q.options,
                    correct: q.correct !== undefined ? q.correct : (q.correctAnswer - 1)
                }));
                examIdx = 0; examScore = 0;
                renderExam(exam.title);
                navigateTo('exam');
            } catch(e) { showToast("Ø®Ø·Ø£ ÙÙŠ Ù‚Ø±Ø§Ø¡Ø© ØµÙŠØºØ© Ø§Ù„Ø§Ù…ØªØ­Ø§Ù†"); }
        }

        function renderExam(title) {
            const cont = document.getElementById('exam-container');
            if(examIdx >= activeExamData.length) {
                if(window.user) window.fb.addDoc(window.fb.getCol('submissions'), { student: "Ø·Ø§Ù„Ø¨ elkhatta", exam: title, score: `${examScore}/${activeExamData.length}`, time: window.fb.serverTimestamp() });
                cont.innerHTML = `<div class="text-center py-10"><i data-lucide="award" class="w-20 h-20 text-yellow-500 mx-auto mb-6"></i><h2 class="text-4xl font-black mb-4 text-gray-800 tracking-tighter">Ø£Ø­Ø³Ù†Øª ØµÙ†Ø¹Ø§Ù‹!</h2><div class="text-8xl font-black text-blue-600 mb-10 tracking-tighter text-center">${examScore} / ${activeExamData.length}</div><button onclick="navigateTo('dashboard')" class="bg-blue-600 text-white px-12 py-4 rounded-2xl font-black shadow-xl hover:bg-blue-700 transition-all">Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</button></div>`;
            } else {
                const q = activeExamData[examIdx];
                cont.innerHTML = `
                    <div class="flex justify-between items-center mb-10"><span class="bg-blue-50 text-blue-600 px-4 py-1 rounded-full text-xs font-black uppercase tracking-widest">Ø³Ø¤Ø§Ù„ ${examIdx+1} Ù…Ù† ${activeExamData.length}</span><button onclick="navigateTo('dashboard')" class="text-slate-300 hover:text-slate-600"><i data-lucide="x"></i></button></div>
                    <h2 class="text-3xl font-black mb-10 leading-snug text-slate-800 text-right">${q.question}</h2>
                    <div class="grid gap-4">${q.options.map((o,i) => `<button onclick="submitAns(${i}, ${q.correct}, '${title}')" class="w-full text-right p-6 rounded-[1.5rem] border-2 border-slate-50 hover:border-blue-500 hover:bg-blue-50 hover:text-blue-700 font-black transition-all shadow-sm">${o}</button>`).join('')}</div>`;
            }
            lucide.createIcons();
        }

        function submitAns(idx, correct, title) { if(idx === correct) examScore++; examIdx++; renderExam(title); }

        function renderSupport() {
            const list = document.getElementById('messages-display');
            list.innerHTML = appData.messages.map(m => `<div class="bg-white p-8 rounded-[3rem] shadow-sm border border-slate-50 animate-fade text-right"><div class="flex gap-4 items-start mb-6"><div class="h-12 w-12 bg-slate-100 rounded-2xl flex items-center justify-center font-black text-slate-400 shrink-0 shadow-inner">Q</div><p class="font-black text-xl text-slate-800 leading-relaxed text-right">${m.text}</p></div>${m.reply ? `<div class="bg-indigo-50 p-6 rounded-[2rem] border border-indigo-100 mr-12 relative shadow-inner text-right"><div class="absolute -top-3 right-8 bg-indigo-600 text-white text-[10px] px-3 py-1 rounded-full font-black">Ø±Ø¯ Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©</div><p class="text-indigo-900 font-bold leading-loose text-right">${m.reply}</p></div>` : '<p class="text-xs text-orange-500 mr-16 font-black italic text-right">Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ù…Ø±Ø§Ø¬Ø¹Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© ÙˆØ§Ù„Ø±Ø¯...</p>'}</div>`).join('') || '<p class="text-center py-20 text-slate-300 font-bold italic text-right">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø±Ø³Ø§Ø¦Ù„ Ù…Ù†Ø´ÙˆØ±Ø©</p>';
            lucide.createIcons();
        }

        async function sendMsg() {
            const v = document.getElementById('support-input').value; if(!v || !window.user) return;
            await window.fb.addDoc(window.fb.getCol('messages'), { text: v, sender: "Ø·Ø§Ù„Ø¨ elkhatta", status: 'pending', createdAt: window.fb.serverTimestamp() });
            document.getElementById('support-input').value = ''; showToast("ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø³Ø¤Ø§Ù„ Ø¨Ù†Ø¬Ø§Ø­");
        }

        function renderAdmin(tab) {
            appData.currentAdminTab = tab;
            document.querySelectorAll('.adm-tab').forEach(b => {
                b.classList.remove('bg-blue-600', 'text-white', 'shadow-lg');
                b.classList.add('text-slate-400');
            });
            const container = document.getElementById('admin-render-area');
            container.innerHTML = '';

            if(tab === 'subjects') {
                container.innerHTML = `<div class="bg-white p-10 rounded-[3rem] shadow-xl border space-y-8 animate-fade text-right">
                    <h2 class="text-2xl font-black text-right">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…ÙˆØ§Ø¯ Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠØ©</h2>
                    <div class="p-6 bg-blue-50 rounded-2xl space-y-4 text-right">
                        <p class="text-xs font-bold text-blue-800 tracking-tighter uppercase text-right">Ø§Ù„Ù…ÙˆØ§Ø¯ Ø§Ù„Ù…Ù‚ØªØ±Ø­Ø© (Ø§Ø¶ØºØ· Ù„Ù„Ø¥Ø¶Ø§ÙØ©):</p>
                        <div class="flex flex-wrap gap-2 justify-end">
                            ${SOCIAL_WORK_SUBJECTS.map(s => `<button onclick="document.getElementById('new-subj-in').value='${s}'" class="bg-white px-3 py-1.5 rounded-xl text-[10px] font-black shadow-sm hover:bg-blue-600 hover:text-white transition-all uppercase">${s}</button>`).join('')}
                        </div>
                    </div>
                    <div class="flex flex-col sm:flex-row gap-3"><input id="new-subj-in" class="flex-1 p-5 bg-slate-50 rounded-2xl border-none font-bold shadow-inner text-right" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø§Ø¯Ø©"><button onclick="adminAddSubj()" class="bg-blue-600 text-white px-10 py-4 rounded-2xl font-black shadow-lg">Ø¥Ø¶Ø§ÙØ©</button></div>
                    <div class="grid gap-3 pt-4">${appData.subjects.map(s => `<div class="flex justify-between items-center p-5 bg-slate-50 rounded-2xl border text-right"><span>${s.name}</span><button onclick="adminDel('subjects', '${s.id}')" class="text-red-400 p-2 hover:bg-red-50 rounded-full transition-all"><i data-lucide="trash-2"></i></button></div>`).join('')}</div></div>`;
            }

            if(tab === 'lectures') {
                container.innerHTML = `<div class="bg-white p-10 rounded-[3rem] shadow-xl border space-y-8 animate-fade text-right">
                    <h2 class="text-2xl font-black text-gray-800 tracking-tighter text-right">Ø±ÙØ¹ Ù…Ø­Ø§Ø¶Ø±Ø© Ù…ØªÙƒØ§Ù…Ù„Ø©</h2>
                    <div class="grid md:grid-cols-2 gap-6 text-right">
                        <div class="md:col-span-2 text-right"><label class="block text-xs font-black text-slate-400 mb-2">Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ù…Ø­Ø§Ø¶Ø±Ø©</label><input id="lec-t-in" class="w-full p-5 bg-slate-50 rounded-2xl border-none font-bold shadow-inner text-right" placeholder="Ù…Ø«Ø§Ù„: Ø§Ù„Ù…Ø­Ø§Ø¶Ø±Ø© Ø§Ù„Ø£ÙˆÙ„Ù‰"></div>
                        <div class="text-right"><label class="block text-xs font-black text-slate-400 mb-2">Ø§Ù„Ù…Ø§Ø¯Ø© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label><select id="lec-s-in" class="w-full p-5 bg-slate-50 rounded-2xl border-none font-bold shadow-inner text-right"><option value="">-- Ø¨Ø¯ÙˆÙ† Ù…Ø§Ø¯Ø© (Ù„Ù„Ø£Ø­Ø¯Ø« ÙÙ‚Ø·) --</option>${appData.subjects.map(s => `<option value="${s.id}">${s.name}</option>`).join('')}</select></div>
                        <div class="text-right"><label class="block text-xs font-black text-slate-400 mb-2">Ø§Ø±Ø¨Ø· Ø¨Ø§Ù…ØªØ­Ø§Ù†</label><select id="lec-e-in" class="w-full p-5 bg-slate-50 rounded-2xl border-none font-bold shadow-inner text-right"><option value="">-- Ø¨Ø¯ÙˆÙ† Ø§Ù…ØªØ­Ø§Ù† --</option>${appData.exams.map(e => `<option value="${e.id}">${e.title}</option>`).join('')}</select></div>
                        <div class="relative group text-center"><label class="flex flex-col items-center justify-center p-8 border-2 border-dashed border-slate-200 rounded-[2rem] cursor-pointer hover:border-blue-400 transition-all"><i data-lucide="video" class="text-slate-300 w-10 h-10 mb-3"></i><span class="text-xs font-black">Ø±ÙØ¹ ÙÙŠØ¯ÙŠÙˆ</span><input type="file" id="f-v" accept="video/*" class="hidden"></label></div>
                        <div class="relative group text-center"><label class="flex flex-col items-center justify-center p-8 border-2 border-dashed border-slate-200 rounded-[2rem] cursor-pointer hover:border-red-400 transition-all"><i data-lucide="file-text" class="text-slate-300 w-10 h-10 mb-3"></i><span class="text-xs font-black">Ø±ÙØ¹ Ù…Ù„Ø²Ù…Ø© (PDF)</span><input type="file" id="f-p" accept=".pdf" class="hidden"></label></div>
                    </div><button id="up-btn" onclick="adminUploadLec()" class="w-full bg-blue-600 text-white py-5 rounded-[1.5rem] font-black shadow-xl hover:bg-blue-700 transition-all">Ù†Ø´Ø± Ø§Ù„Ù…Ø­Ø§Ø¶Ø±Ø©</button></div>`;
            }

            if(tab === 'exams') {
                container.innerHTML = `<div class="bg-white p-10 rounded-[3rem] shadow-xl border space-y-8 animate-fade text-right"><h2 class="text-2xl font-black text-indigo-600 tracking-tighter text-right">Ø¨Ù†Ø§Ø¡ Ø§Ù…ØªØ­Ø§Ù† (JSON)</h2><input id="ex-t-in" class="w-full p-5 bg-slate-50 rounded-2xl border-none font-black shadow-inner text-right" placeholder="Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø§Ù…ØªØ­Ø§Ù†"><textarea id="ex-c-in" rows="6" class="w-full p-6 bg-slate-900 text-green-400 font-mono text-sm rounded-[2rem] text-left shadow-inner" dir="ltr">[{"q": "Ø³Ø¤Ø§Ù„ØŸ", "options": ["Ø£", "Ø¨"], "correct": 0}]</textarea><button onclick="adminAddExam()" class="w-full bg-indigo-600 text-white py-5 rounded-2xl font-black shadow-xl">Ø­ÙØ¸ Ø§Ù„Ø§Ù…ØªØ­Ø§Ù†</button><div class="pt-8 space-y-3 text-right">${appData.exams.map(ex => `<div class="flex justify-between items-center p-4 bg-slate-50 rounded-2xl border text-right"><span>${ex.title}</span><button onclick="adminDel('exams', '${ex.id}')" class="text-red-400 p-2 hover:bg-red-50 rounded-full transition-all"><i data-lucide="trash-2"></i></button></div>`).join('')}</div></div>`;
            }

            if(tab === 'msgs') {
                container.innerHTML = appData.messages.map(m => `<div class="bg-white p-8 rounded-[2.5rem] border shadow-sm space-y-6 animate-fade text-right"><p class="font-black text-lg text-slate-800 text-right">${m.text}</p><div class="flex gap-2"><input id="rep-${m.id}" class="flex-1 p-4 bg-slate-50 rounded-2xl border-none font-bold shadow-inner text-right" placeholder="Ø§ÙƒØªØ¨ Ø±Ø¯Ùƒ Ù‡Ù†Ø§..."><button onclick="adminRep('${m.id}')" class="bg-blue-600 text-white px-8 rounded-2xl font-black transition-all hover:bg-blue-700 shadow-lg"><i data-lucide="send" class="w-5 h-5"></i></button></div></div>`).join('') || '<p class="text-center font-bold text-slate-300 py-20 italic text-right">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø±Ø³Ø§Ø¦Ù„ Ù…Ù†Ø´ÙˆØ±Ø©</p>';
            }
            lucide.createIcons();
        }

        async function adminAddSubj() { const n = document.getElementById('new-subj-in').value; if(!n || !window.user) return; await window.fb.addDoc(window.fb.getCol('subjects'), { name: n, createdAt: window.fb.serverTimestamp() }); document.getElementById('new-subj-in').value = ''; showToast("ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ø§Ø¯Ø©"); }
        async function adminUploadLec() {
            const t = document.getElementById('lec-t-in').value, s = document.getElementById('lec-s-in').value, e = document.getElementById('lec-e-in').value;
            const fv = document.getElementById('f-v').files[0], fp = document.getElementById('f-p').files[0];
            if(!t || !window.user) return showToast("Ø¨ÙŠØ§Ù†Ø§Øª Ù†Ø§Ù‚ØµØ©");
            const btn = document.getElementById('up-btn'); btn.innerText = "Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø±ÙØ¹..."; btn.disabled = true;
            const vUrl = fv ? URL.createObjectURL(fv) : null, pUrl = fp ? URL.createObjectURL(fp) : null;
            await window.fb.addDoc(window.fb.getCol('lectures'), { title: t, subjectId: s || null, examId: e || null, videoUrl: vUrl, pdfUrl: pUrl, createdAt: window.fb.serverTimestamp() });
            showToast("ØªÙ… Ø§Ù„Ù†Ø´Ø± Ø¨Ù†Ø¬Ø§Ø­"); renderAdmin('lectures');
        }
        async function adminAddExam() { const t = document.getElementById('ex-t-in').value, c = document.getElementById('ex-c-in').value; if(!t || !c || !window.user) return; await window.fb.addDoc(window.fb.getCol('exams'), { title: t, content: c, createdAt: window.fb.serverTimestamp() }); showToast("ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø§Ù…ØªØ­Ø§Ù†"); renderAdmin('exams'); }
        async function adminRep(id) { const v = document.getElementById(`rep-${id}`).value; if(!v || !window.user) return; await window.fb.updateDoc(window.fb.getDocRef('messages', id), { reply: v, status: 'answered' }); showToast("ØªÙ… Ø§Ù„Ø±Ø¯"); }
        async function adminDel(col, id) { if(!window.user) return; await window.fb.deleteDoc(window.fb.getDocRef(col, id)); showToast("ØªÙ… Ø§Ù„Ø­Ø°Ù"); }

        document.addEventListener('DOMContentLoaded', () => { lucide.createIcons(); });
    </script>
</body>
</html>